<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=Standards" />
    <title>Web Chat</title>
  </head>
  <body>
    <button onclick="handleAuth()">Start Authentication</button>
    <button onclick="endAuth()">Clear Authentication</button>
  </body>

  <script>
    (function() {
      var ns = document.createElement('script');
      ns.src = ('https://chatapps-sg.netomi.com/app/script.js');
      ns.type = 'text/javascript';
      ns.async = true;
      ns.setAttribute('botRefId', 'b462f607-c7f3-4630-80d3-7bc008880807');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ns, s);
      ns.onload = function () {
        window.NETOMI_WEB_WIDGET.init(() => { /* add publish events here */ })
      }
    })();
  
    let id = null;

    async function handleAuth() {

      async function renewToken() {
        const tokenApiCall = await fetch('https://chatapps-sg.netomi.com/api/fetchJWT',  {
          method: 'post',
          headers: {
            'href':'https://revanshasti.github.io/Hosting-sites/Authentication.html',
            'Content-Type': 'application/json',
            'x-token-expiry': '1h',
            'x-bot-ref-id':'b462f607-c7f3-4630-80d3-7bc008880807',
            'x-user-details': JSON.stringify({"name": "Revan Shasti", "externalId": "revan@gmail.com"})
          }
        });
        const { token } = await tokenApiCall.json();
        return token;
      }
    
      const tokenApiCall = await fetch('https://chatapps-sg.netomi.com/api/fetchJWT',  {
        method: 'post', 
        headers: { 
          'href':'https://revanshasti.github.io/Hosting-sites/Authentication.html',
          'Content-Type': 'application/json', 
          'x-token-expiry': '1h', 
          'x-bot-ref-id':'b462f607-c7f3-4630-80d3-7bc008880807', 
          'x-user-details': JSON.stringify({"name": "Revan Shasti", "externalId": "revan@gmail.com"}) 
        }
      });

      const { token } = await tokenApiCall.json();

      window.NETOMI_WEB_WIDGET.authModule.login(token);

      id = setInterval(() => {
        window.NETOMI_WEB_WIDGET.authModule.jwtAuth(async sendTokenToNetomi => {
          
          const tokenApiCall = await fetch('https://chatapps-sg.netomi.com/api/fetchJWT',  {
            method: 'post',
            headers: {
              'href':'https://revanshasti.github.io/Hosting-sites/Authentication.html',
              'Content-Type': 'application/json',
              'x-token-expiry': '1h',
              'x-bot-ref-id':'b462f607-c7f3-4630-80d3-7bc008880807',
              'x-user-details': JSON.stringify({"name": "Revan Shasti", "externalId": "revan@gmail.com"})
            }
          });

          const tokenResp = await tokenApiCall.json();
          sendTokenToNetomi(tokenResp, renewToken);
        })      
      }, 3300000);
    }

    function endAuth() {
      clearInterval(id);
      window.NETOMI_WEB_WIDGET.authModule.logout();
    }
  </script>
</html>
